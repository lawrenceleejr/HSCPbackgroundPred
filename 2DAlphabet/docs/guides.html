<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>2DAlphabet: Guides</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">2DAlphabet
   &#160;<span id="projectnumber">2.0</span>
   </div>
   <div id="projectbrief">Background modeling framework</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('guides.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Guides </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#mlfit">Running an ML fit</a></li>
<li class="level1"><a href="#limit">Running asymptotic limits</a></li>
<li class="level1"><a href="#stats">Running statistical tests</a></li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="mlfit"></a>
Running an ML fit</h1>
<p>This tool takes as input a list of JSON configuration files (detailed in [configs](configs) via a command such as</p>
<div class="fragment"><div class="line">python run_MLfit.py input_config1.json input_config2.json ... input_configN.json</div></div><!-- fragment --><p>where <code>input_config*.json</code> are the configurations for each Alphabet pair. Based on the input from the JSON files, 2D Alphabet grabs all distributions, generates the RooFit objects from them, creates the pass and fail distributions of the QCD/non-resonant background estimated from data, passes these all to Combine, calls Combine (<code>-M FitDiagnostics</code>), interprets the fit result, and plots the post-fit distributions. It also outputs additional plots and read-out for debugging or reference. The <code>run_MLfit.py</code> script also creates the starting point for all other <code>run_</code> scripts because it:</p><ul>
<li>Takes the model from pre-fit (where we know essentially nothing about the total background estimate) to post-fit where background estimate is meaningful,</li>
<li>Creates a directory where all of the information of the run can be stored and accessed for later use.</li>
</ul>
<p>Thus, <code>run_MLfit.py</code> should be run before the other scripts whenever attempting to fit a new Alphabet pair or a new set of pairs.</p>
<p>The main command line options are provided below with longer descriptions along with the output of <code>python run_MLfit.py --help</code>.</p>
<ul>
<li><code>-q, --tag</code> Assigns a tag for the run. The tag determines the naming of the folder (and some of the nested objects) the will be created during processing. This folder is often referred to as the "project directory". This option takes precedent over tags defined in configuration files and is a good way to ignore the need for configuration files to have the same tag and to make sure you don't overwrite an old result on-the-fly.</li>
<li><code>--rMin/--rMax</code> These are the minimum and maximum bounds of the signal strength (r) in the fit. They default to 0 and 5, respectively. It may be useful to loosen or tighten the bounds if the fit is failing near one of the boundaries.</li>
<li><code>--recycleAll</code> Recycles everything generated in the previous run using the given tag. This means the construction of the workspace, rebinned histograms, and other steps previous to the fit are skipped and the previous run versions are loaded instead. Use this if you haven't changed your configuration file and would like to speed things up.</li>
<li><code>--skipFit</code> Skips running the fit and goes directly to plotting.</li>
<li><code>--skipPlots</code> Skips running the plots. Sometimes this is the part that takes the longest because a sampling method is used to estimate errors.</li>
</ul>
<div class="fragment"><div class="line">Options:</div><div class="line">-h, --help            show this help message and exit</div><div class="line">-q TAG, --tag=TAG     Assigns a tag for this run</div><div class="line">-s V1=1.0,V2=1.0..., --setParameter=V1=1.0,V2=1.0...</div><div class="line">                        String of parameters to set pre-fit. Uses same comma</div><div class="line">                        separated format as Combine (V1=1.0,V2=1.0...)</div><div class="line">--rMin=rMin           Minimum bound on r (signal strength)</div><div class="line">--rMax=rMax           Minimum bound on r (signal strength)</div><div class="line">--recycleAll          Recycle everything from the previous run with this tag</div><div class="line">--skipFit             Skip fit and go directly to plotting (WARNING: Will</div><div class="line">                        use previous fit result if it exists and crash</div><div class="line">                        otherwise)</div><div class="line">--skipPlots           Skip plotting</div><div class="line">--fullRun2            Plot sum of years 16, 17, 18</div><div class="line">--CL=CL               Command-line options to set for all configs</div></div><!-- fragment --><h1><a class="anchor" id="limit"></a>
Running asymptotic limits</h1>
<p>This tool is for calculating limits on the signal strength (<code>r</code>) of a given simulated signal. The script takes the background only fit result <code>fit_b</code> output from <code>run_MLfit.py</code>, morphs a copy of the pre-fit workspace to this result (thus bypassing having to perform a likelihood fit again), generates toys from the background estimate of the morphed pre-fit workspace to create pseudo-data, and fits these toys to derive expected limits for the simulated signal (blinding can be turned off so that the real data is also fit to get an observed limit on <code>r</code>). The actual pseudo-data generation and asymptotic limit calculation is handled by the AsymptoticLimit method of Combine.</p>
<p>Because the background only fit result is used, the signal simulation used in the configuration file for the <code>run_MLfit.py</code> does not matter. However, the signal for limit setting obviously matters and in all likelihood (no pun intended), the user will want to scan over several simulated signals to generate limits as a function of their samples (perhaps each one was generated at a different mass). Note that the model is rebuilt each time a signal (and the associated uncertainty templates) needs to be changed.</p>
<p>You do NOT have to write a configuration file for each simulated sample. At any point in the python call to <code>run_Limit.py</code>, one can provide a string swap specified by the syntax <code>oldString:newString</code> which will replace all instances of <code>oldString</code> in the configuration files provided with <code>newString</code>. In fact this can be used in <code>run_MLfit.py</code> as well.</p>
<p>Running <code>python run_Limit.py --help</code> returns the following:</p>
<div class="fragment"><div class="line">Options:</div><div class="line">-h, --help            show this help message and exit</div><div class="line">-q &lt;tag&gt;, --tag=&lt;tag&gt;</div><div class="line">                        Assigns a tag for this run</div><div class="line">-d &lt;dir&gt;, --projDir=&lt;dir&gt;</div><div class="line">                        Points to the directory where the b-only fit result is</div><div class="line">                        located</div><div class="line">--unblindData         Unblind the observation and calculate the observed</div><div class="line">                        limit</div><div class="line">--recycleAll          Recycle everything from the previous run with this</div><div class="line">                        tag. Note that this does not allow for string</div><div class="line">                        substitution.</div></div><!-- fragment --><h1><a class="anchor" id="stats"></a>
Running statistical tests</h1>
<p>The <code>run_Stats.py</code> tool hosts the infrastructure to run the majority of necessary statistical tests on the model and fit. Each call to <code>run_Stats.py</code> can only be run with a single "mode". The test must be run on a project directory. The available modes are represented by the following options.</p>
<ul>
<li><code>--gof</code> Runs the goodness of fit test for the model in the provided <code>--projDir</code>. If the fit in <code>--projDir</code> is blinded, the goodness of fit test will be blinded as well. The saturated test statistic is used. The KS and AD test statistics are not available because they rely on CDFs which are not well defined for two dimensional distributions.</li>
<li><code>--signalInjection &lt;r&gt;</code> Injects the designated amount of signal <code>&lt;r&gt;</code> on top of the background-only model from <code>--projDir</code>.</li>
<li><code>--ftest &lt;option&gt;</code> Runs a Fischer test comparing the model in <code>--projDir</code> against a model with more parameters, <code>--altDir</code>. The process of running the test is split into several options so that pieces can be recycled between comparisons:</li>
<li><b>generate</b> Generates the toys <code>--projDir</code>. The <code>--altDir</code> does not need to be specified.</li>
<li><b>fitMain</b> Fits the base/main model to the toys generated from itself and calculates the saturated test statistic for each.</li>
<li><b>fitAlt</b> Fits the alternate model to the toys generated from the base model and calculates the saturated test statistic for each.</li>
<li><b>post</b> Collects the outputs and fitAlt and fitMain, plots, and calculates the pvalue when comparing the fits to data against the fits to the toys.</li>
<li><b>pvalue</b> Skips toys entirely and assumes toys follow an F-distribution. The pvalue is calculated when comparing data against the F-distribution. This option is appropriate if you've first confirmed that the toys follow the F-distribution) which is plotted in the <code>post</code> option.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>Statistical tests require that toys (pseudo-data) be generated and run. The number of toys to use can be specified with the <code>-t/--toys</code> option. Typically, 500 toys are a good number to generate and analyze. The intricacies of the toy generation are handled by 2D Alphabet but in general, the toys are generated from a post-fit model (<code>fit_b</code> or a modified version depending on the "mode") and fit with the pre-fit model. The seed for the toys can be changed with the <code>--seed</code> option.</dd>
<dd>
For <code>run_Stats.py</code> specifically, there is the <code>--condor</code> option which will run the Combine commands on condor batch nodes. When <code>--condor</code> is used, the jobs should be monitored by the user. Once the jobs are finished, the same command should be run but with <code>--condor</code> replaced by <code>--post</code> which will collect the returned tarballs, untar them temporarily, and generate the plots.</dd></dl>
<p>The main advantage of using <code>--condor</code> is to split the toys among separate jobs with the <code>--toyJobs</code> option which specifies into how many jobs to split the toys. For example <code>-t 500 --toyJobs 50</code> would put 10 toys into each job. The commands run in each job will have different seeds so that the toys are not identical.</p>
<p>Note that even though the job outputs remain untarred (even after running <code>--post</code>), the folders are not small. Depending on the model, they could be between 1-2 GB. This can eat up space quickly on disk so be cognizant of how many old tests you are saving!</p>
<p>Finally, the 2D Alphabet environment is already tarred and stored on EOS for access to the jobs. If you make changes, you'll need to create a new tarball of the environment and put it on EOS for the condor nodes to access.</p>
<p>The <code>CondorHelper.py</code> can be used to submit jobs for other tools such as <code>run_Limit.py</code>. See [Condor Helper](condorhelper) for more information.</p>
<p>Running <code>python run_Stats.py --help</code> returns the following:</p>
<div class="fragment"><div class="line">Options:</div><div class="line">-h, --help            show this help message and exit</div><div class="line">-d &lt;dir&gt;, --projDir=&lt;dir&gt;</div><div class="line">                        Home of the project - has the cards, fit results, etc</div><div class="line">-a &lt;dir&gt;, --altDir=&lt;dir&gt;</div><div class="line">                        Home of the alternative model that you&#39;d like to</div><div class="line">                        compare against the one in projDir</div><div class="line">-t &lt;N&gt;, --toys=&lt;N&gt;    Number of toys to generate - fed to combine</div><div class="line">--toyJobs=&lt;N&gt;         Number of jobs to split toy fitting into - fed to</div><div class="line">                        condor job building</div><div class="line">--seed=&lt;N&gt;            Seed - fed to combine</div><div class="line">--rMin=&lt;rMin&gt;         Minimum bound on r (signal strength)</div><div class="line">--rMax=&lt;rMax&gt;         Minimum bound on r (signal strength)</div><div class="line">-w &lt;name&gt;             Model workspace (from text2workspace)</div><div class="line">--plotOnly            Only plot</div><div class="line">--dryrun              Dry run the combine commands to console</div><div class="line">--gof                 Perform goodness of fit test</div><div class="line">--signalInjection=&lt;r&gt;</div><div class="line">                        Perform signal injection test</div><div class="line">--ftest=&lt;option&gt;      Perform F test. Options are &#39;generate&#39;, &#39;fitAlt&#39;,</div><div class="line">                        &#39;fitMain&#39;, &#39;post&#39;, &#39;pvalue&#39;</div><div class="line">--post                Run in conjunction with diagnosticsWithToys or</div><div class="line">                        signalInjection and condor jobs to process output</div><div class="line">                        files</div><div class="line">--condor              Submit a condor job (only for signal injection and</div><div class="line">                        diagnosticsWithToys currently</div><div class="line">--skipSnapshot        Use if you&#39;ve already made a snapshot that you trust</div><div class="line">                        for this project directory</div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
